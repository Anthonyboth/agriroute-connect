# Separa√ß√£o entre Fretes e Servi√ßos

## üìã Vis√£o Geral

Este documento explica a arquitetura de separa√ß√£o completa entre **Fretes** (transporte de cargas) e **Servi√ßos** (assist√™ncia t√©cnica, consultoria, etc.) no sistema.

## üéØ Objetivo

Garantir que:
- ‚úÖ **Fretes aparecem APENAS no painel de motoristas**
- ‚úÖ **Servi√ßos aparecem APENAS no painel de prestadores**
- ‚úÖ **Imposs√≠vel criar tipo errado na tabela errada** (valida√ß√£o de banco)
- ‚úÖ **Zero confus√£o entre os dois conceitos**

---

## üóÉÔ∏è Estrutura de Tabelas

### `freights` - Apenas Transporte

**Tipos permitidos (freight_service_type):**
- `FRETE_MOTO` - Frete de moto
- `CARGA` - Carga geral
- `CARGA_GERAL` - Carga geral
- `CARGA_AGRICOLA` - Carga agr√≠cola
- `CARGA_GRANEL` - Carga a granel
- `CARGA_LIQUIDA` - Carga l√≠quida
- `GUINCHO` - Guincho
- `MUDANCA` - Mudan√ßa
- `TRANSPORTE_ANIMAIS` - Transporte de animais
- `TRANSPORTE_MAQUINARIO` - Transporte de maquin√°rio

**Constraint:** `check_freight_service_type`
```sql
CHECK (service_type::text = ANY(ARRAY[
  'FRETE_MOTO', 'CARGA', 'CARGA_GERAL', ...
]::text[]))
```

### `service_requests` - Apenas Servi√ßos

**Tipos permitidos (provider_service_type):**
- `AGRONOMO` - Agr√¥nomo
- `ANALISE_SOLO` - An√°lise de solo
- `ASSISTENCIA_TECNICA` - Assist√™ncia t√©cnica
- `MECANICO` - Mec√¢nico
- `BORRACHEIRO` - Borracheiro
- `CHAVEIRO` - Chaveiro
- `AUTO_ELETRICA` - Auto el√©trica
- `COMBUSTIVEL` - Combust√≠vel
- `LIMPEZA_RURAL` - Limpeza rural
- `PULVERIZACAO_DRONE` - Pulveriza√ß√£o com drone
- `COLHEITA_TERCEIRIZADA` - Colheita terceirizada
- `TOPOGRAFIA` - Topografia
- `ENERGIA_SOLAR` - Energia solar
- `CONSULTORIA_RURAL` - Consultoria rural
- `VETERINARIO` - Veterin√°rio
- `OUTROS` - Outros servi√ßos

**Constraint:** `check_provider_service_type`
```sql
CHECK (service_type::text = ANY(ARRAY[
  'AGRONOMO', 'ANALISE_SOLO', 'ASSISTENCIA_TECNICA', ...
]::text[]))
```

---

## üîß RPCs Exclusivas

### Para Motoristas: `get_freights_for_driver(p_driver_id)`

**Retorna:**
- Apenas registros de `freights`
- Filtra por `service_type` de frete
- **üÜï Aplica filtros de visibilidade** (ALL, TRANSPORTADORAS, AUTONOMOS, AVALIACAO_3, AVALIACAO_4)
- Exclui fretes j√° aceitos pelo motorista
- Inclui fretes parcialmente preenchidos (multi-truck)

**Uso:**
```typescript
const { data } = await supabase.rpc('get_freights_for_driver', {
  p_driver_id: profile.id
});
```

**L√≥gica de Filtragem:**
```sql
-- ALL: Todos motoristas veem o frete
-- TRANSPORTADORAS: Apenas motoristas com company_id
-- AUTONOMOS: Apenas motoristas sem company_id
-- AVALIACAO_3: Rating m√©dio >= 3.0
-- AVALIACAO_4: Rating m√©dio >= 4.0
```

### Para Prestadores: `get_services_for_provider(p_provider_id)`

**Retorna:**
- Apenas registros de `service_requests`
- Filtra por `service_type` de servi√ßo (nunca fretes)
- Exclui servi√ßos j√° aceitos

**Uso:**
```typescript
const { data } = await supabase.rpc('get_services_for_provider', {
  p_provider_id: profile.id
});
```

---

## üéØ Matching Espacial

### Driver Spatial Matching

**Arquivo:** `supabase/functions/driver-spatial-matching/index.ts`

**Filtro aplicado:**
```typescript
const freightServiceTypes = [
  'FRETE_MOTO', 'CARGA', 'CARGA_GERAL', 'CARGA_AGRICOLA', 
  'GUINCHO', 'MUDANCA', 'TRANSPORTE_ANIMAIS', 'TRANSPORTE_MAQUINARIO'
];

const { data: freights } = await supabase
  .from('freights')
  .select('*')
  .eq('status', 'OPEN')
  .in('service_type', freightServiceTypes) // ‚úÖ Apenas fretes
  .limit(500);
```

### Provider Spatial Matching

**Arquivo:** `supabase/functions/service-provider-spatial-matching/index.ts`

**Filtro aplicado:**
```typescript
const providerServiceTypes = [
  'AGRONOMO', 'ANALISE_SOLO', 'ASSISTENCIA_TECNICA', 'MECANICO',
  'BORRACHEIRO', 'CHAVEIRO', 'AUTO_ELETRICA', 'COMBUSTIVEL', ...
];

const { data: serviceRequests } = await supabase
  .from('service_requests')
  .select('*')
  .eq('status', 'OPEN')
  .in('service_type', providerServiceTypes) // ‚úÖ Apenas servi√ßos
  .limit(100);
```

---

## üì± Frontend

### SmartFreightMatcher (Motoristas)

**Arquivo:** `src/components/SmartFreightMatcher.tsx`

```typescript
const { data: freightsData } = await supabase.rpc(
  'get_freights_for_driver', 
  { p_driver_id: profile.id }
);
```

### ServiceProviderDashboard (Prestadores)

**Arquivo:** `src/components/ServiceProviderDashboard.tsx`

```typescript
const { data } = await supabase.rpc(
  'get_services_for_provider',
  { p_provider_id: providerId }
);
```

**Removido:** Filtro manual de `freightTypes` (n√£o √© mais necess√°rio)

---

## ‚úÖ Valida√ß√µes em M√∫ltiplas Camadas

### 1. **Database Constraints** (Primeira linha de defesa)
- `check_freight_service_type` em `freights`
- `check_provider_service_type` em `service_requests`
- **Imposs√≠vel** inserir tipo errado

### 2. **RPCs com Filtros** (Segunda linha de defesa)
- `get_freights_for_driver` - apenas tipos de frete
- `get_services_for_provider` - apenas tipos de servi√ßo

### 3. **Edge Functions** (Terceira linha de defesa)
- `driver-spatial-matching` - filtra `freightServiceTypes`
- `service-provider-spatial-matching` - filtra `providerServiceTypes`

### 4. **Frontend** (Interface do usu√°rio)
- Uso direto das RPCs exclusivas
- Sem necessidade de filtros manuais

---

## üéõÔ∏è Filtros de Visibilidade

### Vis√£o Geral

Permite que produtores **controlem quais motoristas** podem visualizar seus fretes de carga, aplicando crit√©rios como tipo de motorista e avalia√ß√£o.

### Campo `visibility_filter`

**Tabela:** `freights`  
**Tipo:** `text`  
**Padr√£o:** `'ALL'`  
**Valores permitidos:**

| Filtro | Descri√ß√£o | Quem V√™ |
|--------|-----------|---------|
| `ALL` | Todos motoristas | Motoristas aut√¥nomos + Transportadoras |
| `TRANSPORTADORAS` | Apenas empresas | Motoristas com `company_id` |
| `AUTONOMOS` | Apenas aut√¥nomos | Motoristas sem `company_id` |
| `AVALIACAO_3` | Avalia√ß√£o ‚â• 3 estrelas | Rating m√©dio >= 3.0 |
| `AVALIACAO_4` | Avalia√ß√£o ‚â• 4 estrelas | Rating m√©dio >= 4.0 |

### Constraint de Banco

```sql
ALTER TABLE freights ADD CONSTRAINT check_visibility_filter 
CHECK (visibility_filter IN ('ALL', 'TRANSPORTADORAS', 'AUTONOMOS', 'AVALIACAO_3', 'AVALIACAO_4'));
```

### Aplica√ß√£o na RPC

A RPC `get_freights_for_driver` aplica automaticamente os filtros:

```sql
WHERE 
  (f.visibility_filter = 'ALL' OR
   (f.visibility_filter = 'TRANSPORTADORAS' AND p.company_id IS NOT NULL) OR
   (f.visibility_filter = 'AUTONOMOS' AND p.company_id IS NULL) OR
   (f.visibility_filter = 'AVALIACAO_3' AND avg_rating >= 3.0) OR
   (f.visibility_filter = 'AVALIACAO_4' AND avg_rating >= 4.0))
```

### Interface do Usu√°rio

**Arquivo:** `src/components/CreateFreightModal.tsx`

```tsx
{formData.service_type === 'CARGA' && (
  <RadioGroup value={formData.visibility_filter || 'ALL'}>
    <div className="flex items-center space-x-2">
      <RadioGroupItem value="ALL" id="ALL" />
      <Label htmlFor="ALL">Todos motoristas</Label>
    </div>
    <div className="flex items-center space-x-2">
      <RadioGroupItem value="TRANSPORTADORAS" id="TRANSPORTADORAS" />
      <Label htmlFor="TRANSPORTADORAS">Apenas transportadoras</Label>
    </div>
    {/* ... outros filtros */}
  </RadioGroup>
)}
```

### Casos de Uso

**Caso 1:** Produtor precisa de transporte certificado
```
Frete de Carga Refrigerada ‚Üí visibility_filter = 'TRANSPORTADORAS'
Resultado: Apenas transportadoras veem o frete
```

**Caso 2:** Produtor quer motoristas experientes
```
Frete de Carga Fr√°gil ‚Üí visibility_filter = 'AVALIACAO_4'
Resultado: Apenas motoristas com rating ‚â• 4.0
```

**Caso 3:** Frete urgente sem restri√ß√µes
```
Frete de Carga Geral ‚Üí visibility_filter = 'ALL'
Resultado: Todos motoristas dispon√≠veis
```

---

## üîÑ Reabrir Frete

### Vis√£o Geral

Permite que **produtores** reabram fretes conclu√≠dos ou cancelados, criando uma **c√≥pia completa** do frete original com status `OPEN`.

### RPC: `reopen_freight(p_freight_id uuid)`

**Funcionalidade:**
- Duplica todos os dados do frete original
- Define status como `OPEN`
- Mant√©m `producer_id` do frete original
- Adiciona metadata sobre a reabertura

**C√≥digo SQL:**
```sql
CREATE OR REPLACE FUNCTION public.reopen_freight(p_freight_id uuid)
RETURNS uuid AS $$
DECLARE
  v_new_freight_id uuid;
  v_original_freight record;
BEGIN
  SELECT * INTO v_original_freight FROM freights WHERE id = p_freight_id;
  
  IF v_original_freight.status NOT IN ('DELIVERED', 'CANCELLED') THEN
    RAISE EXCEPTION 'Apenas fretes entregues ou cancelados podem ser reabertos';
  END IF;

  INSERT INTO freights (
    producer_id, service_type, cargo_type, cargo_description,
    weight, origin_city, origin_state, destination_city, destination_state,
    pickup_date, price, urgency, status, visibility_filter
  ) VALUES (
    v_original_freight.producer_id,
    v_original_freight.service_type,
    v_original_freight.cargo_type,
    v_original_freight.cargo_description || ' (Reaberto)',
    v_original_freight.weight,
    v_original_freight.origin_city,
    v_original_freight.origin_state,
    v_original_freight.destination_city,
    v_original_freight.destination_state,
    CURRENT_DATE + INTERVAL '1 day',
    v_original_freight.price,
    v_original_freight.urgency,
    'OPEN',
    v_original_freight.visibility_filter
  ) RETURNING id INTO v_new_freight_id;

  RETURN v_new_freight_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = public;
```

### Interface do Usu√°rio

**Arquivo:** `src/components/FreightHistory.tsx`

```tsx
{freight.status === 'DELIVERED' && freight.producer_id === session?.user?.id && (
  <Button
    variant="outline"
    size="sm"
    onClick={() => handleReopenFreight(freight.id)}
    disabled={reopening}
  >
    <RefreshCw className="h-4 w-4 mr-2" />
    Reabrir Frete
  </Button>
)}
```

**Fun√ß√£o de Reabertura:**
```typescript
const handleReopenFreight = async (freightId: string) => {
  const { data, error } = await supabase.rpc('reopen_freight', {
    p_freight_id: freightId
  });

  if (!error) {
    toast.success("Frete reaberto com sucesso!");
    fetchFreights();
  }
};
```

### Fluxo de Reabertura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  1. Produtor visualiza hist√≥rico    ‚îÇ
‚îÇ     Status: DELIVERED ou CANCELLED   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇ  2. Clica "Reabrir Frete" ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇ  3. RPC reopen_freight()  ‚îÇ
     ‚îÇ     - Valida status       ‚îÇ
     ‚îÇ     - Duplica dados       ‚îÇ
     ‚îÇ     - Status = OPEN       ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇ  4. Novo frete criado    ‚îÇ
     ‚îÇ     - Edit√°vel           ‚îÇ
     ‚îÇ     - Republic√°vel       ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇ  5. Matching espacial     ‚îÇ
     ‚îÇ     - Notifica motoristas ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Casos de Uso

**Caso 1:** Transporte recorrente
```
Produtor tem frete semanal de leite ‚Üí Reabre frete anterior
Resultado: Economiza tempo, mant√©m mesmos dados (cidades, peso, etc.)
```

**Caso 2:** Frete cancelado por engano
```
Produtor cancelou por erro ‚Üí Reabre imediatamente
Resultado: Republica sem precisar preencher tudo novamente
```

**Caso 3:** Demanda sazonal
```
Colheita em v√°rias etapas ‚Üí Reabre frete ap√≥s cada entrega
Resultado: Mant√©m hist√≥rico e facilita repeti√ß√£o
```

---

## üîÑ Migra√ß√£o de Dados

A migra√ß√£o autom√°tica moveu todos os registros de **tipos de frete** que estavam incorretamente em `service_requests` para a tabela `freights`.

**Fun√ß√£o:** `migrate_freight_requests_to_freights()`

**Tipos migrados:**
- `FRETE_MOTO`
- `CARGA`, `CARGA_GERAL`, `CARGA_AGRICOLA`
- `GUINCHO`, `MUDANCA`
- `TRANSPORTE_ANIMAIS`, `TRANSPORTE_MAQUINARIO`

---

## üÜï Como Adicionar Novos Tipos

### Adicionar Novo Tipo de Frete

1. **Atualizar o enum:**
```sql
ALTER TYPE freight_service_type ADD VALUE 'NOVO_TIPO_FRETE';
```

2. **Atualizar constraint:**
```sql
ALTER TABLE freights DROP CONSTRAINT check_freight_service_type;
ALTER TABLE freights ADD CONSTRAINT check_freight_service_type 
CHECK (service_type::text = ANY(ARRAY[
  'FRETE_MOTO', ..., 'NOVO_TIPO_FRETE'
]::text[]));
```

3. **Atualizar RPCs e Edge Functions** (adicionar aos arrays de filtro)

### Adicionar Novo Tipo de Servi√ßo

1. **Atualizar o enum:**
```sql
ALTER TYPE provider_service_type ADD VALUE 'NOVO_SERVICO';
```

2. **Atualizar constraint:**
```sql
ALTER TABLE service_requests DROP CONSTRAINT check_provider_service_type;
ALTER TABLE service_requests ADD CONSTRAINT check_provider_service_type 
CHECK (service_type::text = ANY(ARRAY[
  'AGRONOMO', ..., 'NOVO_SERVICO'
]::text[]));
```

3. **Atualizar RPCs e Edge Functions** (adicionar aos arrays de filtro)

---

## üêõ Troubleshooting

### Frete n√£o aparece no painel do motorista

**Poss√≠veis causas:**
1. ‚úÖ Verificar se `service_type` √© um tipo de frete v√°lido
2. ‚úÖ Confirmar que est√° na tabela `freights` (n√£o `service_requests`)
3. ‚úÖ Status deve ser `OPEN` ou com vagas dispon√≠veis
4. ‚úÖ Motorista deve ter cidade/√°rea compat√≠vel
5. üÜï **Verificar `visibility_filter`** - Motorista pode estar filtrado

**Exemplo:**
```
Frete com visibility_filter = 'TRANSPORTADORAS'
Motorista aut√¥nomo (company_id = null) ‚Üí N√ÉO v√™ o frete ‚úÖ
```

### üÜï Frete s√≥ aparece para alguns motoristas

**Causa:** Filtro de visibilidade aplicado

**Verifica√ß√µes:**
1. Consultar `visibility_filter` do frete
2. Verificar se motorista atende aos crit√©rios:
   - `TRANSPORTADORAS`: Tem `company_id`?
   - `AUTONOMOS`: N√£o tem `company_id`?
   - `AVALIACAO_3`: Rating m√©dio >= 3.0?
   - `AVALIACAO_4`: Rating m√©dio >= 4.0?

**Solu√ß√£o para produtor:** Editar frete e mudar para `ALL`

### üÜï N√£o consigo reabrir frete

**Poss√≠veis causas:**
1. ‚úÖ Status n√£o √© `DELIVERED` ou `CANCELLED`
2. ‚úÖ Usu√°rio n√£o √© o produtor original do frete
3. ‚úÖ Erro de permiss√£o na RPC

**Solu√ß√£o:**
```sql
-- Verificar status do frete
SELECT id, status, producer_id FROM freights WHERE id = 'freight-id';

-- Deve retornar status = 'DELIVERED' ou 'CANCELLED'
-- E producer_id = id do usu√°rio logado
```

### üÜï Frete reaberto n√£o mant√©m dados corretos

**Verifica√ß√µes:**
1. Checar se RPC `reopen_freight` est√° copiando todos os campos
2. Verificar se `visibility_filter` foi preservado
3. Conferir se `pickup_date` foi ajustado para data futura

**SQL de diagn√≥stico:**
```sql
SELECT 
  original.id as original_id,
  original.cargo_description as original_desc,
  reopened.id as reopened_id,
  reopened.cargo_description as reopened_desc,
  reopened.visibility_filter
FROM freights original
JOIN freights reopened ON reopened.cargo_description LIKE original.cargo_description || '%'
WHERE original.status = 'DELIVERED';
```

### Servi√ßo aparece no painel errado

**Solu√ß√£o:**
- Verificar constraints do banco
- Confirmar uso das RPCs corretas
- Checar filtros nas edge functions

### Erro ao criar frete/servi√ßo

**Causa:** Tentativa de inserir tipo incompat√≠vel
**Solu√ß√£o:** Usar o tipo correto conforme a tabela

---

## üìä Diagrama de Fluxo Completo

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              PRODUTOR cria FRETE DE CARGA                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ üÜï Escolhe Filtro de         ‚îÇ
         ‚îÇ Visibilidade? (OPCIONAL)     ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚îÇ                 ‚îÇ                 ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    ALL     ‚îÇ  ‚îÇTRANSPORTA-  ‚îÇ  ‚îÇ AVALIACAO   ‚îÇ
‚îÇ  (padr√£o)  ‚îÇ  ‚îÇDORAS/AUT√îN. ‚îÇ  ‚îÇ   ‚â•3/‚â•4     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ                 ‚îÇ                 ‚îÇ
      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  Frete publicado em          ‚îÇ
         ‚îÇ  tabela FREIGHTS             ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  Matching Espacial           ‚îÇ
         ‚îÇ  (respeita visibility_filter)‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  Motoristas/Transport.       ‚îÇ
         ‚îÇ  veem frete (FILTRADO)       ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  Frete executado             ‚îÇ
         ‚îÇ  Status = DELIVERED          ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ üÜï Bot√£o "Reabrir Frete"     ‚îÇ
         ‚îÇ  (Apenas para produtor)      ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ RPC reopen_freight()         ‚îÇ
         ‚îÇ - Duplica todos os dados     ‚îÇ
         ‚îÇ - Status = OPEN              ‚îÇ
         ‚îÇ - Mant√©m visibility_filter   ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  Novo frete criado           ‚îÇ
         ‚îÇ  (Edit√°vel antes de publicar)‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò


‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   PRODUTOR      ‚îÇ
‚îÇ  cria solicita√ß√£o‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ √â FRETE?‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ                   ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FRETE    ‚îÇ    ‚îÇ SERVI√áO    ‚îÇ
‚îÇ (freights‚îÇ    ‚îÇ(service_   ‚îÇ
‚îÇ  table)  ‚îÇ    ‚îÇ requests)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ                 ‚îÇ
     ‚îÇ                 ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇMOTORISTA ‚îÇ    ‚îÇPRESTADOR  ‚îÇ
‚îÇDashboard ‚îÇ    ‚îÇDashboard  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìö Arquivos Relacionados

**Banco de Dados:**
- Migration: `supabase/migrations/[timestamp]_freight_vs_services.sql`
- üÜï Migration: `supabase/migrations/20251024052508_*_visibility_reopen.sql`
- Fun√ß√£o migra√ß√£o: `migrate_freight_requests_to_freights()`
- RPCs: `get_freights_for_driver()`, `get_services_for_provider()`
- üÜï RPC: `reopen_freight(p_freight_id uuid)`

**Edge Functions:**
- `supabase/functions/driver-spatial-matching/index.ts`
- `supabase/functions/service-provider-spatial-matching/index.ts`

**Frontend:**
- `src/components/SmartFreightMatcher.tsx`
- `src/components/ServiceProviderDashboard.tsx`
- üÜï `src/components/CreateFreightModal.tsx` (campo visibility_filter)
- üÜï `src/components/FreightHistory.tsx` (bot√£o reabrir)

---

## üîê Seguran√ßa

- ‚úÖ Constraints impedem dados incorretos no banco
- ‚úÖ RPCs com security definer e set search_path
- ‚úÖ Filtros em m√∫ltiplas camadas
- ‚úÖ RLS policies aplicadas corretamente
- ‚úÖ Valida√ß√£o de tipos em tempo de inser√ß√£o

---

## ‚ú® Resultado Final

‚úÖ **Separa√ß√£o Total**: Fretes em `freights`, servi√ßos em `service_requests`
‚úÖ **Constraints DB**: Imposs√≠vel inserir tipo errado
‚úÖ **RPCs Dedicadas**: Cada painel usa sua pr√≥pria RPC exclusiva
‚úÖ **Matching Isolado**: Drivers s√≥ veem fretes, providers s√≥ veem servi√ßos
‚úÖ **Zero Confus√£o**: C√≥digo claro e manuten√≠vel
‚úÖ **Performance**: Queries otimizadas sem filtros manuais
‚úÖ **Seguran√ßa**: Valida√ß√µes em m√∫ltiplas camadas
üÜï **Filtros de Visibilidade**: Produtores controlam quem v√™ seus fretes
üÜï **Reabrir Fretes**: Reutiliza√ß√£o de fretes conclu√≠dos com um clique
üÜï **Flexibilidade**: Sistema adapt√°vel a diferentes necessidades de transporte
